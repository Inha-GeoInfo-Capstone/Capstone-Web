<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ GNSS ì§€ë„</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map { height: 500px; width: 100%; }
    </style>
</head>
<body>
    <h1>ì‹¤ì‹œê°„ GNSS ì§€ë„</h1>
    <div id="map"></div>

    <script>
        // 1ï¸âƒ£ Leafletì„ ì‚¬ìš©í•˜ì—¬ ì§€ë„ ìƒì„±
        var map = L.map('map').setView([37.5665, 126.9780], 13);

        // 2ï¸âƒ£ OpenStreetMap íƒ€ì¼ ì¶”ê°€
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 3ï¸âƒ£ ì¶”ì •ëœ GPS ì¢Œí‘œë¥¼ ì‚¬ìš©í•´ ë§ˆì»¤ ìƒì„±
        var marker;

        function  getData() {
            fetch("https://inhamap.n-e.kr/gps",{
                method: "GET"
            })
            .then(response => response.json())
            .then(data => {
                // ì¶”ì •ëœ ì¢Œí‘œê°€ ì„œë²„ì—ì„œ ë°›ì•„ì¡Œì„ ë•Œ
                if (data.status === "success") {
                    let Lat = data.latitude;
                    let Lon = data.longitude;
                    let snr = data.snr;

                    console.log("ğŸ“Œ GPS ë°ì´í„°:", Lat, Lon, snr);

                    // 6ï¸âƒ£ ì¶”ì •ëœ GPS ì¢Œí‘œë¡œ ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                    updateMarker(Lat, Lon, snr);
                }
                else{
                    updateLocation();
                }
            })
            .catch(error => console.error("âŒ ì—ëŸ¬ ë°œìƒ:", error));  
        }

        function updateMarker(lat, lon,snr) {
            let markerColor = getColorBySNR(snr);
            if (marker) {
                // ê¸°ì¡´ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                marker.setLatLng([lat, lon]).setIcon(createMarkerIcon(markerColor));
            } else {
                // ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ë§ˆì»¤ ì¶”ê°€
                marker = L.marker([lat, lon], { icon: createMarkerIcon(markerColor) }).addTo(map);
            }
            map.setView([lat, lon], 13);  // ì§€ë„ ì¤‘ì‹¬ì„ ì¶”ì •ëœ ì¢Œí‘œë¡œ ì„¤ì •
        }

        function getColorBySNR(snr) {
            if (snr >= 40) return "green";
            if (snr >= 30) return "orange";
            if (snr >= 20) return "red";
        }

        // SNRì— ë§ëŠ” ìƒ‰ìƒì˜ ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±
        function createMarkerIcon(color) {
            return L.divIcon({
                className: 'custom-icon',
                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%;"></div>`,
                iconSize: [20, 20]
            });
        }

        function updateLocation() { // ì»´í“¨í„°ë¡œ ì ‘ì†í–ˆì„ë•Œ (ì„œë²„ì—ì„œ ë°›ì„ ìœ„ê²½ë„ê°€ ì—†ì„ë•Œ)
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    let lat = position.coords.latitude;
                    let lon = position.coords.longitude;
                    let alt = position.coords.altitude || 0;  // ê³ ë„ ê°’ ë°›ê¸°, ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì„¤ì •
                    
                    console.log("ğŸ“Œ í˜„ì¬ ìœ„ì¹˜:", lat, lon, alt);
                    updateMarker(lat,lon);
                });
            } else {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        setInterval(updateLocation, 3000);
    </script>
</body>
</html>