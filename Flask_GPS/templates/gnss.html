<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ GNSS ì§€ë„</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map { height: 500px; width: 100%; }
    </style>
</head>
<body>
    <h1>ì‹¤ì‹œê°„ GNSS ì§€ë„</h1>
    <div id="map"></div>

    <script>
        const FLASK_URL = "https://inhacapstone.p-e.kr/gps"; // ì‹¤ì œ ë°°í¬ url 
        // 1ï¸âƒ£ Leafletì„ ì‚¬ìš©í•˜ì—¬ ì§€ë„ ìƒì„±
        var map = L.map('map').setView([37.5665, 126.9780], 13);

        // 2ï¸âƒ£ OpenStreetMap íƒ€ì¼ ì¶”ê°€
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 3ï¸âƒ£ ì¶”ì •ëœ GPS ì¢Œí‘œë¥¼ ì‚¬ìš©í•´ ë§ˆì»¤ ìƒì„±
        var marker;

        function getData() {
            fetch(FLASK_URL, { method: "GET" })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    let lat = data.latitude;
                    let lon = data.longitude;
                    let snr = data.snr;
                    console.log("ğŸ“¡ Flaskì—ì„œ ìˆ˜ì‹ í•œ ìœ„ì¹˜:", lat, lon, snr);
                    updateMarker(lat, lon, snr);
                } else {
                    console.warn("âš ï¸ ì„œë²„ ìœ„ì¹˜ ì—†ìŒ â†’ fallback");
                    updateLocation();  // ë¸Œë¼ìš°ì € GPS fallback
                }
            })
            .catch(error => {
                console.error("âŒ Flask ì„œë²„ ìš”ì²­ ì‹¤íŒ¨:", error);
                updateLocation();  
            });
        }

        function updateLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const snr = 25;  // ê¸°ë³¸ê°’ 
                    console.log("ğŸ“ ë¸Œë¼ìš°ì € ìœ„ì¹˜:", lat, lon);
                    updateMarker(lat, lon, snr);
        
                    // ì„œë²„ë¡œ í˜„ì¬ ìœ„ì¹˜ ì „ì†¡ (ì‹¤ì‹œê°„ ì „ì†¡)
                    fetch(FLASK_URL, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            latitude: lat,
                            longitude: lon,
                            snr: snr
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        console.log("âœ… ì„œë²„ì— ìœ„ì¹˜ ì „ì†¡ ì„±ê³µ:", data);
                    })
                    .catch(error => {
                        console.error("âŒ ì„œë²„ ì „ì†¡ ì‹¤íŒ¨:", error);
                    });
        
                }, error => {
                    console.warn("â— ìœ„ì¹˜ ì ‘ê·¼ ì‹¤íŒ¨:", error);
                });
            } else {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        function updateMarker(lat, lon, snr) {
            let color = getColorBySNR(snr);
            if (marker) {
                marker.setLatLng([lat, lon]).setIcon(createMarkerIcon(color));
            } else {
                marker = L.marker([lat, lon], {
                    icon: createMarkerIcon(color)
                }).addTo(map);
            }
            map.setView([lat, lon], 13);
        }

        function getColorBySNR(snr) {
            if (snr >= 40) return "green";
            if (snr >= 30) return "orange";
            if (snr >= 20) return "red";
        }

        // SNRì— ë§ëŠ” ìƒ‰ìƒì˜ ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±
        function createMarkerIcon(color) {
            return L.divIcon({
                className: 'custom-icon',
                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%;"></div>`,
                iconSize: [20, 20]
            });
        }

        setInterval(getData, 3000);
    </script>
</body>
</html>